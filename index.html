<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>2022 æ±æ­¢é‡‘å±±è¬é‡Œ é¸èˆ‰åœ°åœ–åˆ†æ</title>
    
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <style>
        body { margin: 0; padding: 0; display: flex; height: 100vh; font-family: "Microsoft JhengHei", Arial, sans-serif; }
        
        /* å·¦å´åœ°åœ–å€ */
        #map { flex: 2; height: 100%; z-index: 1;}
        
        /* å³å´è³‡è¨Šé¢æ¿ */
        #panel { 
            flex: 1; 
            min-width: 350px;
            padding: 20px; 
            background: #f8f9fa; 
            overflow-y: auto; 
            box-shadow: -2px 0 5px rgba(0,0,0,0.1);
            z-index: 2;
        }

        .card { background: white; padding: 15px; border-radius: 8px; margin-bottom: 20px; box-shadow: 0 2px 4px rgba(0,0,0,0.05); }
        h2 { margin-top: 0; color: #333; border-bottom: 2px solid #007bff; padding-bottom: 10px; }
        h3 { font-size: 1.1em; color: #666; margin-bottom: 10px; }
        
        /* æ•¸æ“šæ‘˜è¦å€å¡Š */
        .stat-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 15px; }
        .stat-item { text-align: center; background: #e9ecef; padding: 8px; border-radius: 5px; }
        .stat-val { font-weight: bold; font-size: 1.2em; color: #007bff; }
        .stat-label { font-size: 0.8em; color: #666; }

        .legend { background: white; padding: 10px; border-radius: 5px; box-shadow: 0 0 5px rgba(0,0,0,0.2); font-size: 12px; }
        .legend i { width: 18px; height: 18px; float: left; margin-right: 8px; opacity: 0.8; }
    </style>
</head>
<body>

    <div id="map"></div>
    
    <div id="panel">
        <h2 id="village-name">è«‹é»é¸åœ°åœ–ä¸Šçš„é‡Œ</h2>
        
        <div class="card">
            <h3>ğŸ—³ï¸ 2022 è­°å“¡å¾—ç¥¨åˆ†å¸ƒ</h3>
            <canvas id="voteChart"></canvas>
        </div>

        <div class="card">
            <h3>ğŸ‘¥ äººå£å¹´é½¡çµæ§‹</h3>
            <div id="age-stats" class="stat-grid">
                </div>
            <canvas id="ageChart"></canvas>
        </div>
    </div>

    <script>
        // ================= è¨­å®šå€ =================
        // å€™é¸äººä»£è¡¨è‰² (æ ¹æ“šæ”¿é»¨æˆ–å€‹äººå½¢è±¡)
        const CANDIDATE_COLORS = {
            "å»–å…ˆç¿”": "#000095", // åœ‹æ°‘é»¨è—
            "ç™½ç®èŒ¹": "#548CBB", // åœ‹æ°‘é»¨æ·ºè—
            "å¼µéŒ¦è±ª": "#1B9431", // æ°‘é€²é»¨ç¶ 
            "å‘¨é›…ç²": "#59B96C", // æ°‘é€²é»¨æ·ºç¶ 
            "å½­ç«‹ä¿¡": "#00CACA", // æ°‘çœ¾é»¨(å‡è¨­è‰²)
            "é»ƒç‘å‚³": "#888888", // ç„¡é»¨/å…¶ä»–
            "å…¶ä»–": "#CCCCCC"
        };
        
        // ç›®æ¨™è¡Œæ”¿å€ (éæ¿¾åœ°åœ–ç”¨)
        const TARGET_DISTRICTS = ["æ±æ­¢å€", "é‡‘å±±å€", "è¬é‡Œå€"];

        // ================= åˆå§‹åŒ–åœ°åœ– =================
        const map = L.map('map').setView([25.15, 121.65], 12); // èšç„¦åœ¨æ±æ­¢/è¬é‡Œäº¤ç•Œ
        
        L.tileLayer('https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png', {
            attribution: 'Â© OpenStreetMap contributors'
        }).addTo(map);

        let geojsonLayer;
        let myChart1 = null; // åœ“é¤…åœ–å¯¦ä¾‹
        let myChart2 = null; // é•·æ¢åœ–å¯¦ä¾‹

        // ================= è¼‰å…¥è³‡æ–™ =================
        Promise.all([
            fetch('final_data.json').then(r => r.json()),
            fetch('new_taipei_villages.json').then(r => r.json()) // è«‹ç¢ºä¿ä½ æœ‰ä¸‹è¼‰é€™å€‹æª”æ¡ˆ
        ]).then(([data, geojson]) => {
            initDashboard(data, geojson);
        }).catch(err => {
            console.error("è®€å–å¤±æ•—:", err);
            alert("è³‡æ–™è®€å–å¤±æ•—ï¼è«‹ç¢ºèª final_data.json å’Œ new_taipei_villages.json æ˜¯å¦å­˜åœ¨ï¼Œä¸”æ‚¨æ˜¯é€é Local Server (å¦‚ VSCode Live Server) é–‹å•Ÿç¶²é ã€‚");
        });

        function initDashboard(electionData, geojson) {
            
            // ä¿®æ­£é»ï¼šæ”¹ç”¨ ADMIT ä¾†ç¯©é¸è¡Œæ”¿å€
            const features = geojson.features.filter(f => {
                return TARGET_DISTRICTS.includes(f.properties.ADMIT);
            });

            // å¦‚æœç¯©é¸å®Œé‚„æ˜¯ç©ºçš„ï¼Œè·³å‡ºè­¦å‘Š (ä½†é€™æ¬¡æ‡‰è©²æœƒæˆåŠŸäº†ï¼)
            if (features.length === 0) {
                alert("è­¦å‘Šï¼šç¯©é¸å¾Œæ²’æœ‰ä»»ä½•è³‡æ–™ï¼è«‹ç¢ºèª GeoJSON å…§æ˜¯å¦æœ‰ æ±æ­¢å€/é‡‘å±±å€/è¬é‡Œå€ çš„è³‡æ–™ã€‚");
            }

            features.forEach(f => {
                // ä¿®æ­£é»ï¼šçµ„åˆ Key æ™‚æ”¹ç”¨ ADMIT å’Œ ADMIV
                // ä¾‹å¦‚: "æ±æ­¢å€" + "ä¸­èˆˆé‡Œ"
                const key = f.properties.ADMIT + f.properties.ADMIV;
                
                // ç¶å®šé¸èˆ‰æ•¸æ“š
                f.properties.electionInfo = electionData[key] || null;
            });

            // ç¹ªè£½åœ°åœ–åœ–å±¤
            geojsonLayer = L.geoJSON(features, {
                style: styleFeature,
                onEachFeature: onEachFeature
            }).addTo(map);
            
            // è‡ªå‹•èª¿æ•´åœ°åœ–è¦–é‡
            if (features.length > 0) {
                map.fitBounds(geojsonLayer.getBounds());
            }
            
            addLegend();
        }

        // ================= åœ°åœ–æ¨£å¼é‚è¼¯ =================
        function styleFeature(feature) {
            const info = feature.properties.electionInfo;
            let fillColor = '#ddd'; // é è¨­ç°è‰² (ç„¡è³‡æ–™)

            if (info) {
                // æ‰¾å‡ºæœ€é«˜ç¥¨å€™é¸äºº
                let winner = "";
                let maxVotes = -1;
                for (const [name, val] of Object.entries(info.candidates)) {
                    if (val.votes > maxVotes) {
                        maxVotes = val.votes;
                        winner = name;
                    }
                }
                fillColor = CANDIDATE_COLORS[winner] || '#888';
            }

            return {
                fillColor: fillColor,
                weight: 1,
                opacity: 1,
                color: 'white',
                dashArray: '3',
                fillOpacity: 0.7
            };
        }

        function onEachFeature(feature, layer) {
            layer.on({
                mouseover: (e) => {
                    const layer = e.target;
                    layer.setStyle({ weight: 3, color: '#666', dashArray: '', fillOpacity: 0.9 });
                },
                mouseout: (e) => {
                    geojsonLayer.resetStyle(e.target);
                },
                click: (e) => {
                    updatePanel(feature.properties);
                }
            });
        }

        // ================= æ›´æ–°å³å´é¢æ¿ =================
        function updatePanel(props) {
            const data = props.electionInfo;
            
            // ä¿®æ­£é»ï¼šé¡¯ç¤ºæ¨™é¡Œæ™‚ï¼Œæ”¹ç”¨ ADMIT å’Œ ADMIV
            const title = props.ADMIT + props.ADMIV; 
            document.getElementById('village-name').innerText = title;

            if (!data) {
                document.getElementById('age-stats').innerHTML = "<p>ç„¡æ­¤é‡Œæ•¸æ“š</p>";
                // æ¸…ç©ºåœ–è¡¨... (ç•¥ï¼Œä¿æŒåŸæœ¬é‚è¼¯)
                return;
            }

            // 1. æ›´æ–°é¸èˆ‰åœ“é¤…åœ–
            const candidates = Object.keys(data.candidates);
            const votes = candidates.map(c => data.candidates[c].votes);
            const colors = candidates.map(c => CANDIDATE_COLORS[c] || '#999');

            const ctx1 = document.getElementById('voteChart').getContext('2d');
            if (myChart1) myChart1.destroy();
            
            myChart1 = new Chart(ctx1, {
                type: 'pie',
                data: {
                    labels: candidates,
                    datasets: [{
                        data: votes,
                        backgroundColor: colors
                    }]
                },
                options: {
                    plugins: { legend: { position: 'right' } }
                }
            });

            // 2. æ›´æ–°å¹´é½¡çµæ§‹åœ–èˆ‡æ•¸æ“š
            const age = data.age_structure;
            if (age) {
                // æ›´æ–°æ•¸å­—å¡
                const html = `
                    <div class="stat-item"><div class="stat-val">${age.age_20_39.pct}%</div><div class="stat-label">é’å¹´ (20-39)</div></div>
                    <div class="stat-item"><div class="stat-val">${age.age_65_up.pct}%</div><div class="stat-label">é•·è€… (65+)</div></div>
                `;
                document.getElementById('age-stats').innerHTML = html;

                // ç•«é•·æ¢åœ–
                const ctx2 = document.getElementById('ageChart').getContext('2d');
                if (myChart2) myChart2.destroy();

                myChart2 = new Chart(ctx2, {
                    type: 'bar',
                    data: {
                        labels: ['é’å¹´ (20-39)', 'å£¯å¹´ (40-64)', 'é•·è€… (65+)'],
                        datasets: [{
                            label: 'äººå£ä½”æ¯” (%)',
                            data: [age.age_20_39.pct, age.age_40_64.pct, age.age_65_up.pct],
                            backgroundColor: ['#36A2EB', '#FFCE56', '#FF6384']
                        }]
                    },
                    options: {
                        indexAxis: 'y', // æ©«å‘é•·æ¢åœ–
                        scales: { x: { beginAtZero: true, max: 100 } }
                    }
                });
            } else {
                document.getElementById('age-stats').innerHTML = "ç„¡å¹´é½¡è³‡æ–™";
            }
        }

        function addLegend() {
            const legend = L.control({position: 'bottomleft'});
            legend.onAdd = function (map) {
                const div = L.DomUtil.create('div', 'legend');
                div.innerHTML += '<strong>æœ€é«˜ç¥¨å€™é¸äºº</strong><br>';
                for (const [name, color] of Object.entries(CANDIDATE_COLORS)) {
                    if (name !== 'å…¶ä»–') {
                        div.innerHTML += `<i style="background:${color}"></i> ${name}<br>`;
                    }
                }
                return div;
            };
            legend.addTo(map);
        }

    </script>
</body>
</html>